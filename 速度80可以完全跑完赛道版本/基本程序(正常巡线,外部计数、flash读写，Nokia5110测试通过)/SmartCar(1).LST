C51 COMPILER V9.01   SMARTCAR                                                              11/10/2015 18:46:58 PAGE 1   


C51 COMPILER V9.01, COMPILATION OF MODULE SMARTCAR
OBJECT MODULE PLACED IN SmartCar.OBJ
COMPILER INVOKED BY: D:\Keil\C51\BIN\C51.EXE SmartCar.c BROWSE DEBUG OBJECTEXTEND

line level    source

   1          //¾§Õñ 12MHz 1TÄ£Ê½  ×ÜÏßÆµÂÊ12MHz£¬Ò»¸öÖ¸Áî1/12us
   2          #include "STC12C5A60S2.H"      //STC12C5A60S2µÄÍ·ÎÄ¼þ
   3          #include "nokia_5110.h"
   4          #include "key.h"
   5          #include "flash.h"
   6          //#define uchar unsigned char    //ºê¶¨Òå
   7          #define uint unsigned int
   8          
   9          #define T0_HIGH      0xff   //T0¼ÆÊ±Æ÷¼Ä´æÆ÷³õÖµ
  10          #define T0_LOW      0x83 //Òç³ö¼ÆÊý160¸ö£¬160*£¨1/16£©¶¨Ê±ÖÜÆÚ10us
  11                                      //ÎªÁË±£Ö¤Ö÷³ÌÐòÕý³£ÔËÐÐ£¬¶¨Ê±Æ÷¼ÆÊý×îºÃ²»ÒªÐ¡ÓÚ80¸ö
  12          
  13          #define MOTOR_MAX_PWM_COUNT  100 //PWM¼ÆÊýÆ÷×î´óÖµ 10us*100=1ms,1000Hz
  14          #define SERVO_MAX_PWM_COUNT  1010//1000=20ms,50HZ //¶æ»ú¿ØÖÆ¸ßµçÆ½0.5~2.5ms¶ÔÓ¦PWMµÄ50~250
  15                                           //¶æ»ú¿ØÖÆÆµÂÊÔÚ50~100HzÖ®¼ä£¬ÕâÀïÑ¡50Hz
  16          
  17                                        //×¢Òâ£¬¶æ»ú´ò½Ç¹ý´ó»á´òÔÚµ×ÅÌÉÏ£¬ÇëÁ¢¼´¶Ïµç£¬ÒÔÃâËðº¦¶æ»ú
  18          
  19          #define ERROR_HISTORY_NUM 5   //ÀúÊ·Æ«²î¼ÇÂ¼¸öÊý
  20          
  21          
  22          sbit LEFT_MOTOR_PWM_PORT=P3^7; // µç»úPWM¿ØÖÆ¶Ë¿Ú
  23          sbit RIGHT_MOTOR_PWM_PORT=P3^6;
  24          //       sbit LEFT_MOTOR_PWM_PORT=P3^1; // µç»úPWM¿ØÖÆ¶Ë¿Ú
  25           //    sbit RIGHT_MOTOR_PWM_PORT=P3^0;
  26          sbit SERVO_PWM_PORT=P3^5;   //¶æ»úPWM¿ØÖÆ¶Ë¿Ú
  27          
  28          
  29          
  30          bit control_period_finished=0; //¿ØÖÆÖÜÆÚ½áÊø±êÖ¾Î»£¬¿ØÖÆÖÜÆÚÑ¡Ôñ20ms
  31                                         //Ò²¿É×Ô¼ºÈ·¶¨¿ØÖÆÖÜÆÚ£¬µ«ÊÇÒª±£Ö¤Ö÷³ÌÐòÔÚ¿ØÖÆÖÜÆÚÄÚ¿ÉÒÔÔËÐÐÍê
  32                                                                           //Ò»Ö±ÔÚ×îºóµÄÖÐ¶ÏÄÇÀï¿ÉÒÔÕÒµ½
  33          
  34          char motor_PWM_counter=0;//Éú³Éµç»úPWMµÄ¼ÆÊýÆ÷
  35          char left_motor_PWM=0;   //×óÓÒµç»úµÄPWMÕ¼¿Õ±È //ÓÉÓÚÊýÖµÔÚ128ÒÔÄÚ£¬ËùÒÔ¶¨ÒåÎªchar
  36          char right_motor_PWM=0;
  37           //char left_motor_PWM=50;   //×óÓÒµç»úµÄPWMÕ¼¿Õ±È //ÓÉÓÚÊýÖµÔÚ128ÒÔÄÚ£¬ËùÒÔ¶¨ÒåÎªchar
  38          //char right_motor_PWM=50;
  39          
  40          int servo_PWM_counter=0;//Éú³É¶æ»úPWMµÄ¼ÆÊýÆ÷
  41          int servo_PWM=0;//¶æ»úPWM //³¬¹ýcharÐÍ±äÁ¿µÄ·¶Î§
  42          //unsigned char servo_middle=130;
  43                                    unsigned char servo_middle=140;         //µ÷Õâ¸ö¿ÉÒÔ¸Ä±ä¶æ»úÆäÍ£Ö¹Ê±µÄ½Ç¶È¡£
  44          
  45          int P2H=0;
  46          sbit end=P1^3;
  47          sbit boma1=P1^4;
  48          int error=0;    //±¾´ÎÆ«²î
  49          int error_history[ERROR_HISTORY_NUM]={0};  //ÀúÊ·Æ«²î
  50          
  51          unsigned char servo_P=28;   //PIDÏµÊý
  52          unsigned char servo_D=55 ;
  53                                                                                                                                                                                                                            
  54          char speed_expect=80;  //¸ø¶¨ËÙ¶È                        ,90Ì«¿ìÁË£¬85±È½Ï¿ì¡£
  55          
C51 COMPILER V9.01   SMARTCAR                                                              11/10/2015 18:46:58 PAGE 2   

  56          int timecount=0;
  57          int frequent=0;
  58          int T0count=0;
  59          int T1count=0;
  60          
  61          int count=0;
  62          int temp=0;
  63          int worse=0;                                    //°Ñworse¼Ó´ó!!!!!
  64          
  65          int SUM=0;
  66          
  67          void sys_init(void)    //ÏµÍ³³õÊ¼»¯
  68          {
  69   1      //ÈôflashÒÑ¾­ÓÐÊý¾ÝÇÒ²»Îª0xff,½«ÉÏ´ÎÐÞ¸Ä²ÎÊýµÄÊý¾Ý¸³¸øÏàÓ¦±äÁ¿£¬±ÜÃâÊ×´ÎflashÀïÃæÎÞÊý¾Ý
  70   1      if(read(0x00,0x00)!=255) servo_P=read(0x00,0x00);//     servo_P´æ´¢µØÖ·
  71   1      if(read(0x00,0x01)!=255) servo_D=read(0x00,0x01);//     servo_D´æ´¢µØÖ·
  72   1      if(read(0x00,0x02)!=255) servo_middle=read(0x00,0x02);//servo_middle´æ´¢µØÖ·
  73   1      if(read(0x00,0x03)!=255) speed_expect=read(0x00,0x03);//speed_expect´æ´¢µØÖ·£¬ÎÒ×Ô¼º¼ÓµÄ
  74   1      
  75   1              //------IO¿ÚÉèÖÃ------------
  76   1          P0M1=0x00;  //ÍÆÍìÊä³ö
  77   1          P0M0=0xff;
  78   1          P0=0xff;   
  79   1      
  80   1          P1M1=0x00; //×¼Ë«Ïò¿Ú
  81   1          P1M0=0x00;
  82   1          P1=0xff; //³õÊ¼»¯Îª¸ßµçÆ½ 
  83   1              
  84   1              P2M1=0x00;//Ö¸Ê¾µÆ£¬ÉèÖÃÎªÊä³ö
  85   1          P2M0=0x00;
  86   1          P2=0xff;
  87   1      
  88   1          P3M1=0x00;//P3¿Ú¸ßËÄÎ»ÉèÎªÍÆÍìÊä³ö²úÉúPWM£¬µÍËÄÎ»ÉèÖÃ³É×¼Ë«Ïò¿Ú£¬ÓÃÒÔÍâ²¿ÖÐ¶ÏÂö³å¼ÆÊý
  89   1          P3M0=0xf0;
  90   1              P3=0x0f;
  91   1      
  92   1          LEFT_MOTOR_PWM_PORT=0; //PWM¿ÚÉèÎªµÍµçÆ½£¬µç»ú²»×ª
  93   1          RIGHT_MOTOR_PWM_PORT=0;
  94   1          //left_motor_PWM=0;    //Õ¼¿Õ±ÈÉèÖÃÎª0
  95   1          //right_motor_PWM=0;
  96   1              left_motor_PWM=80;    //Õ¼¿Õ±ÈÉèÖÃÎª0
  97   1          right_motor_PWM=80;
  98   1          servo_PWM=servo_middle;//¶æ»ú´ò½Çµ½ÖÐÐÄ
  99   1      
 100   1          //------¶¨Ê±Æ÷ÉèÖÃ------------
 101   1          AUXR=AUXR | 0x80; //¶¨Ê±Æ÷0²»·ÖÆµ
 102   1          TMOD=0x11;        //¶¨Ê±Æ÷·½Ê½1
 103   1          TH0=T0_HIGH;      //¶¨Ê±Æ÷¸³³õÖµ
 104   1          TL0=T0_LOW ;
 105   1       /*****************ÈôÃ»ÓÐËÙ¶È±Õ»·£¬±¾²¿·Ö¿ÉÒÔ×¢ÊÍµô*********************/
 106   1       /*
 107   1       //¿ªÆôÁ½Â·Íâ²¿ÖÐ¶Ï£¬ÓÃÓÚ±àÂëÆ÷Âö³å¼ÆÊý
 108   1          IT0=1;//ÏÂ½µÑØ´¥·¢
 109   1              EX0=1; 
 110   1              IT1=1;//ÏÂ½µÑØ´¥·¢
 111   1              EX1=1;
 112   1              IPH=0x04;
 113   1              IP=0x04;//PX1=1;//½«Íâ²¿ÖÐ¶Ï1ÓÅÏÈ¼¶ÉèÎª×î¸ß
 114   1              */                                                                                              //ÎÒÃ»ÓÐ±àÂëÆ÷£¬ËùÒÔ×¢ÊÍµô
 115   1      /**********************±¾²¿·ÖÒà¿É²ÉÓÃSTC12×Ô´øÁ½Â·Ó²¼þÂö³å²¶×½¹¦ÄÜÊµÏÖ£¬²ÎÕÕCCAPM0\CCAPM1*****************
             -******************************/   
 116   1              TR0=1;      //¶¨Ê±Æ÷ÔËÐÐ
C51 COMPILER V9.01   SMARTCAR                                                              11/10/2015 18:46:58 PAGE 3   

 117   1          ET0=1;      //¿ª¶¨Ê±Æ÷ÖÐ¶Ï
 118   1          EA=1;       //¿ª×ÜÖÐ¶Ï                                                                               
 119   1      
 120   1      }
 121          //-----------------------------------------------------------------------
 122          int ABS(int i)    //¾ø¶ÔÖµº¯Êý
 123          {
 124   1          if (i>=0) return i;
 125   1          else return -i;
 126   1      }
 127          //-----------------------------------------------------------------------
 128          void getposition(void)//Ç°Ãæ9¸öºìÍâ¶Ô¹Ü£¬Ò²¿ÉÒÔ½áºÏ×Ô¼ººìÍâ¶Ô¹Ü¸öÊýºÍÅÅ²¼×ÔÐÐÁ¿»¯Æ«²î
 129          {
 130   1             
 131   1                 P2H=(P2&0xff);//´Ó×óµ½ÓÒ1-8¸öºìÍâ¶Ô¹Ü×´Ì¬£¬¾­µçÑ¹±È½ÏÆ÷ºóÒÀ´ÎÁ¬P2.7-P2.0
 132   1                 P2H=(P2H<<1);//×óÒÆÒ»Î»
 133   1                 P2H=P2H+(P1&0x80);//½«×óÒÆÒ»Î»ºóµÄÖµ°´Î»ÓëÉÏ´Ó×óµ½ÓÒµÚ9¸öºìÍâ¶Ô¹Ü(¾­µçÑ¹±È½ÏÆ÷ºóÁ¬½ÓÖÁP1.7)µÄÖµ£¬P1&0x
             -80ÊÇ½«P1¿ÚµÄ×î¸ßÎ»È¡³ö 
 134   1                 //P2H=001000000      ;//ÎÒ×Ô¼º¼ÓµÄ²âÊÔÒ»ÏÂÎÒµ¥Æ¬»úµÄ½Ó¿ÚÊÇ·ñ»µÁË¡£
 135   1             switch(P2H&0x1ff)//×îÖÕP2HµÄµÍ¾ÅÎ»£¬Ã¿Ò»Î»µÄ×´Ì¬´ú±íÁËÇ°ÃæºìÍâ¶Ô¹ÜÕÕµ½ºÚÏßÉÏµÄÇé¿ö£¬
 136   1                 //¾­µçÑ¹±È½ÏÆ÷Êä³ö¸ßµçÆ½´ú±íÏÂ·½ÎªºÚÏß(¶ÔÓ¦ÄÇÒ»Î»Îª1)£¬ÕÕÔÚ°×É«ÅÜµÀÉÏÎªµÍµçÆ½(¶ÔÓ¦ÄÇÒ»Î»Îª0)
 137   1                  {
 138   2                      case 0x100: error=-12;worse/=2;    break;
 139   2                      case 0x180: error=-11;worse/=2;    break;
 140   2                      case 0x080: error=-9;worse/=2;    break;
 141   2                      case 0x0c0: error=-7;worse/=2;    break;                
 142   2                      case 0x040: error=-5;worse/=2;    break;          //left
 143   2              case 0x060: error=-3;worse/=2;    break;                                                
 144   2                      case 0x020: error=-2;worse/=2;     break;                               
 145   2                      case 0x030: error=-1;worse/=2;     break;
 146   2                      
 147   2                                  
 148   2              case 0x010: error=0;worse/=2;     break;
 149   2                      
 150   2                                
 151   2              case 0x018: error=1;worse/=2;     break;            
 152   2              case 0x008: error=2;worse/=2;     break;           
 153   2              case 0x00c: error=3;worse/=2;     break;                  
 154   2              case 0x004: error=5;worse/=2;     break;              
 155   2              case 0x006: error=7;worse/=2;     break;       // right
 156   2              case 0x002: error=9;worse/=2;     break;            
 157   2              case 0x003: error=11;worse/=2;     break;             
 158   2              case 0x001: error=12;worse/=2;    break;           
 159   2      
 160   2                      case 0x000: error=error_history[ERROR_HISTORY_NUM-1];break;       //000000000 0x000  
 161   2              default: error=error_history[ERROR_HISTORY_NUM-1];worse++; break;    //ÆäËûÇé¿öÊ±£¬±£³ÖÉÏÒ»´ÎÆ«²î
 162   2                      }
 163   1       //worse±íÊ¾´íÎóÐÅºÅ£¬µ±³öÏÖ0x000»òÕßÆäËûÇé¿öÐÅºÅÊ±£¬
 164   1       //±íÊ¾ÐÅºÅ²»Õý³£,ÀÛ¼Ó¼ÆÊý£¬´ïµ½Ò»¶¨ÊýÁ¿Ê±¿ÉÒÔÈÏ¶¨³µÒÑ¾­³ö½ç£¬Áîµç»ú×ªËÙÎª0£¬±ÜÃâ×²»µ
 165   1      } 
 166          
 167              
 168          void servo_control(void) //¶æ»ú¿ØÖÆ
 169          {
 170   1          char i=0;
 171   1      
 172   1          if(ABS(error-error_history[4])>=11) //Èç¹ûÁ½´ÎµÄÆ«²î¹ý´ó£¬Ôò±£³ÖÉÏÒ»´ÎµÄÆ«²î
 173   1              error=error_history[4];      //·ÀÖ¹²»È·¶¨Çé¿ö£¨ÈçºìÍâ¹Ü³å³öÅÜµÀ£©Ôì³ÉµÄÆ«²îÌø±ä
 174   1          //¸ù¾ÝÆ«²î¼ÆËã¶æ»ú½Ç¶ÈÊä³ö
 175   1           servo_PWM = servo_middle+(servo_P*error    //±ÈÀý
 176   1                         + servo_D*(error-error_history[4])//Î¢·Ö
 177   1                    )/10;   //ÕâÀïÊ¹ÓÃ³ËÒÔÒ»¸ö´óµÄÏµÊýÔÙ³ýÒÔÒ»¸öÊýµÄ·½·¨
C51 COMPILER V9.01   SMARTCAR                                                              11/10/2015 18:46:58 PAGE 4   

 178   1                             //½«Ð¡Êý¼ÆËã×ª»»³ÉÕûÊý¼ÆËã£¬Èç*0.1¿É×ª»»Îª*10/100¡£ÒÔ¼õÇáµ¥Æ¬»úµÄ¸ºµ£
 179   1        //servo_PWM  =100     ;
 180   1        //servo_PWM= servo_middle+(servo_P*error    //±ÈÀý
 181   1            //             + servo_D*(error-error_history[4]-50)//Î¢·Ö
 182   1             //      )/3;   //ÕâÀïÊ¹ÓÃ³ËÒÔÒ»¸ö´óµÄÏµÊýÔÙ³ýÒÔÒ»¸öÊýµÄ·½·¨
 183   1                             //½«Ð¡Êý¼ÆËã×ª»»³ÉÕûÊý¼ÆËã£¬Èç*0.1¿É×ª»»Îª*10/100¡£ÒÔ¼õÇáµ¥Æ¬»úµÄ¸ºµ£
 184   1      
 185   1      
 186   1        // if(servo_PWM<95)      //ÏÞ·ù
 187   1                               if(servo_PWM<90)      //ÏÞ·ù
 188   1          //    servo_PWM=95;     //·ÀÖ¹¶æ»ú³¬¹ý¼«ÏÞÖµ
 189   1                              servo_PWM=90;     //·ÀÖ¹¶æ»ú³¬¹ý¼«ÏÞÖµ
 190   1         // if(servo_PWM>165)
 191   1               if(servo_PWM>170)
 192   1           //   servo_PWM=165;
 193   1                       servo_PWM=170;
 194   1        for(i=0;i<ERROR_HISTORY_NUM-1;i++)    //¼ÇÂ¼Æ«²î
 195   1          {
 196   2              error_history[i]=error_history[i+1];
 197   2          }
 198   1          error_history[ERROR_HISTORY_NUM-1]=error;
 199   1      
 200   1      }
 201          
 202          
 203          
 204          void motor_control(void) //µç»ú¿ØÖÆ
 205          {
 206   1          left_motor_PWM=speed_expect;   //ËÙ¶È¿ØÖÆ
 207   1          right_motor_PWM=speed_expect;  //¿ÉÒÔÖ±½Ó¸ø¶¨£¬Ò²¿ÉÒÔ¸ù¾ÝÈüµÀÇé¿ö¼ÆËãµÃ³ö
 208   1      
 209   1              if(worse>=30)//Ç°Ãæ´«¸ÐÆ÷ÐÅºÅ²»Õý³££¬ÀÛ¼ÆN´ÎÅÐ¶¨Îª³å³öÅÜµÀ£¬·ÀÖ¹³µ×²»µ£¬µç»úËÙ¶È¸ø0               //worseÐèÒª¼Ó´ó£¡£
             -¡£¡£¡£¡
 210   1              {
 211   2              left_motor_PWM=0;
 212   2          right_motor_PWM=0;
 213   2              }
 214   1              
 215   1               
 216   1          if(left_motor_PWM>MOTOR_MAX_PWM_COUNT)   //ÏÞ·ù
 217   1              left_motor_PWM=MOTOR_MAX_PWM_COUNT;
 218   1          if(left_motor_PWM<0)
 219   1              left_motor_PWM=0;
 220   1      
 221   1          if(right_motor_PWM>MOTOR_MAX_PWM_COUNT)
 222   1              right_motor_PWM=MOTOR_MAX_PWM_COUNT;
 223   1          if(right_motor_PWM<0)
 224   1              right_motor_PWM=0;
 225   1      }
 226          
 227          void flash_store()//Ïà¹ØÐÞ¸Ä²ÎÊýÐ´Èëflash±£´æÆðÀ´£¬·½±ãµ÷ÊÔ,Ïà¹Øº¯Êý¼ûflash.c
 228          {
 229   1      del(0x00,0x00);//½«ÉÈÇø³õÊ¼»¯
 230   1      delay_ms(5);
 231   1      write(0x00,0x00,servo_P);
 232   1      delay_ms(5);
 233   1      write(0x00,0x01,servo_D);
 234   1      delay_ms(5);
 235   1      write(0x00,0x02,servo_middle);
 236   1      }
 237          
 238          
C51 COMPILER V9.01   SMARTCAR                                                              11/10/2015 18:46:58 PAGE 5   

 239           /**********************************************************
 240          º¯ÊýÃû£ºservo_test
 241          ËµÃ÷£º²âÊÔ¶æ»úÊÇ·ñÄÜ¹»×óÓÒÕý³£°Ú¶¯
 242          Èë¿Ú£ºÎÞ
 243          ³ö¿Ú£ºÎÞ
 244          ±¸×¢£º½«boma1ÓÃ¶Å°îÏßÁ¬ÖÁP1.4¿Ú£¬²¦¶¯²¦Âë¿ª¹Ø1¿ÉÑ¡ÔñÕý³£Ä£Ê½»ò¶æ»ú²âÊÔÄ£Ê½
 245          
 246          ***********************************************************/
 247          void servo_test()
 248          {
 249   1        static uint i=0;
 250   1        if(i<120)
 251   1          i=i+1;
 252   1        else 
 253   1          i=0;
 254   1        if(i<=30||(i>90&&i<=120))
 255   1              servo_PWM-=1;
 256   1        else if(i>30&&i<=90)
 257   1              servo_PWM+=1;
 258   1      }                                                       //Ò¶ÉñÐÂ¼ÓµÄ,²âÊÔÁËÒ»ÏÂ£¬ÊÇ¿ÉÒÔµÄ¡£
 259          
 260          
 261          //-----------------------------------------------------------------------
 262          void main(void)
 263          {       
 264   1          sys_init();
 265   1          LCD_init();
 266   1              pre_show();
 267   1          P1=0xff;
 268   1              /*
 269   1              while(end)
 270   1          {
 271   1              KeyScan();
 272   1                      pre_show();
 273   1                      if(~end)  //Èç¹û¼ì²âµ½µÍµçÆ½£¬ËµÃ÷°´¼ü°´ÏÂ
 274   1           {
 275   1               LCD_DLY_ms(10);   //ÑÓÊ±È¥¶¶£¬Ò»°ã10-20ms
 276   1             if(~end)     //ÔÙ´ÎÈ·ÈÏ°´¼üÊÇ·ñ°´ÏÂ£¬Ã»ÓÐ°´ÏÂÔòÍË³ö
 277   1                   {
 278   1              while(~end);//Èç¹ûÈ·ÈÏ°´ÏÂ°´¼üµÈ´ý°´¼üÊÍ·Å£¬Ã»ÓÐÊÍ·ÅÔòÒ»Ö±µÈ´ý
 279   1              end=0;
 280   1                       }
 281   1                }
 282   1               flash_store();
 283   1      
 284   1          }                             */                     //°ÑÕâ¸ö×¢ÊÍµôÖ®ºó³õÊÔ³É¹¦£¡£¡£¡¼á³ÖÕæÀí£¡£¡£¡£¡
 285   1          while(1)
 286   1          {   
 287   2                               //ÎÒ½«¼üÅÌÉ¨ÃèµÄ³ÌÐòÒÆ¶¯µ½ÕâÏÂÃæÀ´¡£
 288   2                 /*
 289   2                      KeyScan();
 290   2                      pre_show();
 291   2                      if(~end)  //Èç¹û¼ì²âµ½µÍµçÆ½£¬ËµÃ÷°´¼ü°´ÏÂ
 292   2           {
 293   2               LCD_DLY_ms(10);   //ÑÓÊ±È¥¶¶£¬Ò»°ã10-20ms
 294   2             if(~end)     //ÔÙ´ÎÈ·ÈÏ°´¼üÊÇ·ñ°´ÏÂ£¬Ã»ÓÐ°´ÏÂÔòÍË³ö
 295   2                   {
 296   2              while(~end);//Èç¹ûÈ·ÈÏ°´ÏÂ°´¼üµÈ´ý°´¼üÊÍ·Å£¬Ã»ÓÐÊÍ·ÅÔòÒ»Ö±µÈ´ý
 297   2              end=0;
 298   2                       }
 299   2                }
 300   2               flash_store();          //ÎÒµ£ÐÄÕâµÄ¾Í»á¶Ô¶æ»úµÄ¼ì²âÊ±¼äÓÐÓ°Ïìµ¼ÖÂ·´Ó¦²»¼°Ê±£¬Ó°Ïì¿ØÖÆÖÜÆÚ£¡
C51 COMPILER V9.01   SMARTCAR                                                              11/10/2015 18:46:58 PAGE 6   

 301   2                     */
 302   2                      //
 303   2                      if(!boma1)                       //Ñ¡ÔñÄ£Ê½-¶æ»ú²âÊÔ»òÕý³£Ñ­¼£
 304   2                      servo_test();            //¶æ»ú²âÊÔ
 305   2                      else
 306   2                      {
 307   3              getposition();  //ÅÐ¶ÏºÚÏßÎ»ÖÃ
 308   3              servo_control();//¿ØÖÆ¶æ»ú
 309   3                      //servo_PWM=90;                                         //°ÑÉÏÃæÄÇ¸öÑ­»·×¢ÊÍµôÖ®ºóÕâ¸ö²Å¿ªÊ¼Æð×÷ÓÃ£¡£¡£¡£¡
 310   3                      motor_control();//¿ØÖÆµç»ú
 311   3                      }
 312   2              while(control_period_finished==0);  //µÈ´ý¿ØÖÆÖÜÆÚ20msµ½´ï,±£Ö¤Ã¿´Î¿ØÖÆµÄÊ±¼ä¼ä¸ô¶¼ÏàÍ¬
 313   2              {
 314   3                      control_period_finished=0; //±êÖ¾Î»ÇåÁã
 315   3                  }   
 316   2          }
 317   1      }
 318          
 319          void exint0() interrupt 0 //Íâ²¿ÖÐ¶Ï0²âËÙ,ÖÐ¶ÏºÅ0
 320          {
 321   1         T0count++;  
 322   1      }
 323          void exint1() interrupt 2 //Íâ²¿ÖÐ¶Ï1²âËÙ£¬ÖÐ¶ÏºÅ2
 324          {
 325   1         T1count++;  
 326   1      }
 327                          
 328          
 329          void TIME_BASE(void) interrupt 1 using 1   //¶¨Ê±Æ÷Éú³ÉPWM  //²»Çå³þµÄ¿ÉÒÔ²Î¿¼PWMµÄ¶¨Òå
 330          {
 331   1          TH0=T0_HIGH;        //¸³³õÖµ
 332   1          TL0=T0_LOW ;
 333   1      
 334   1          motor_PWM_counter++;  //¼ÆÊýÆ÷+1 ,Ã¿+1±íÊ¾10us
 335   1          servo_PWM_counter=servo_PWM_counter+1;
 336   1      
 337   1          if(motor_PWM_counter>100)   //PWM±È½Ï¡¢Éú³É
 338   1          {
 339   2              motor_PWM_counter=1; //´Ó1¿ªÊ¼¼ÆÊý
 340   2          }
 341   1          if(servo_PWM_counter>1010)   //PWM±È½Ï¡¢Éú³É
 342   1          {
 343   2      
 344   2              servo_PWM_counter=1; //´Ó1¿ªÊ¼¼ÆÊý
 345   2              control_period_finished=1;  //20ms¿ØÖÆÖÜÆÚµ½´ï£¬±êÖ¾Î»ÖÃ1£¬ÕâÀï½èÓÃÁË¶æ»ú¿ØÖÆÖÜÆÚ20ms£¨50Hz£©£¬
 346   2                                  //Èç¹û¸ü¸ÄÖ÷³ÌÐò¿ØÖÆÖÜÆÚ£¬¿É¶¨ÒåÒ»¸öÀàËÆÓÚservo_PWM_counterµÄ¼ÆÊýÆ÷¼ÆÊ±
 347   2                  timecount++;
 348   2          }
 349   1      
 350   1          if(left_motor_PWM>=motor_PWM_counter)   //×óÓÒPWM
 351   1              LEFT_MOTOR_PWM_PORT=1;  //¶Ë¿ÚÊä³ö¸ßµçÆ½
 352   1          else
 353   1              LEFT_MOTOR_PWM_PORT=0;  //¶Ë¿ÚÊä³öµÍµçÆ½
 354   1      
 355   1      
 356   1          if(right_motor_PWM>=motor_PWM_counter)   //×óÓÒPWM
 357   1              RIGHT_MOTOR_PWM_PORT=1;  //¶Ë¿ÚÊä³ö¸ßµçÆ½
 358   1          else
 359   1              RIGHT_MOTOR_PWM_PORT=0;  //¶Ë¿ÚÊä³öµÍµçÆ½
 360   1      
 361   1          if(servo_PWM>=servo_PWM_counter)//¶æ»úPWM
 362   1              SERVO_PWM_PORT=1;
C51 COMPILER V9.01   SMARTCAR                                                              11/10/2015 18:46:58 PAGE 7   

 363   1          else
 364   1              SERVO_PWM_PORT=0;
 365   1                      
 366   1              
 367   1      if(timecount>=5)//20ms*5=100ms£¬Ã¿100msÍ³¼ÆÒ»´ÎÂö³å¸öÊý 
 368   1          { 
 369   2           frequent=(T0count+T1count)/2;
 370   2           T0count=0;//ÖÃ0ÖØÐÂ¼ÆÊý
 371   2               T1count=0;//ÖÃ0ÖØÐÂ¼ÆÊý
 372   2           timecount=0;
 373   2          }
 374   1      }       
 375          


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =   1136    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =     43       1
   IDATA SIZE       =   ----    ----
   BIT SIZE         =      1    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
